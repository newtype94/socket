<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebSocket test</title>
    <script type="text/javascript">
      let wSocket;
      let logs;
      const userId = "kyh";

      const transaction = {
        userId: 123,
        voiceHash: "md5 hash by voice",
        timeStamp: new Date().getTime(),
      };

      let blocks = [
        {
          index: 1,
          hash: "firstBlockHash",
          previousHash: "none",
          createdAt: 1562000010000,
          data: {
            userId: "kyh",
            voiceHash: "firstVoiceHash",
            timeStamp: 1562000000000,
          },
        },
        {
          index: 2,
          hash:
            "d058abab5582e7ec62dd7e29768931d7970679460468b29a1d9380d4ea870950",
          previousHash: "firstBlockHash",
          createdAt: 1587000010000,
          data: {
            userId: "kyh",
            voiceHash: "secondVoiceHash",
            timeStamp: 1587000000000,
          },
        },
        {
          index: 3,
          hash:
            "a9a811cfb7f0549ae95ff488a0ef49be7c15998d226824b6475a86f27db901fa",
          previousHash: "secondBlockHash",
          createdAt: 1588000010000,
          data: {
            userId: "kyh",
            voiceHash: "thirdVoiceHash",
            timeStamp: 1588000000000,
          },
        },
      ];
      const newnew = {
        index: 4,
        hash:
          "a9a811cfb7f0549ae95ff488a0ef49be7c15998d226824b6475a86f27db901fa",
        previousHash: "secondBlockHash",
        createdAt: 1588000010000,
        data: {
          userId: "kyh",
          voiceHash: "thirdVoiceHash",
          timeStamp: 1588000000000,
        },
      };

      window.onload = () => {
        wSocket = new WebSocket(
          "wss://9qmjknn869.execute-api.ap-northeast-2.amazonaws.com/Prod"
        );

        logs = document.getElementById("result");

        wSocket.onopen = () => {
          logs.textContent += "opened";
        };
        wSocket.onclose = () => {
          logs.textContent += `\n` + "WebSocket closed!";
        };
        wSocket.onerror = (e) => {
          logs.textContent += "Error : " + e.data;
        };
        wSocket.onmessage = onMessage;
      };

      function onMessage(e) {
        const got = JSON.parse(e.data);

        switch (got.message) {
          case "checkPlz":
            console.log(got);
            checkResponse(got.data.requester);
            break;
          case "checkResult":
            console.log(got);
            break;
          default:
            break;
        }
      }

      function doOpen() {
        wSocket = new WebSocket(
          "wss://9qmjknn869.execute-api.ap-northeast-2.amazonaws.com/Prod"
        );

        wSocket.onopen = onOpen;
        wSocket.onclose = onClose;
        wSocket.onmessage = onMessage;
        wSocket.onerror = onError;
      }

      function doClose() {
        wSocket.close();
      }

      function add() {
        //newnew.index = parseInt(document.getElementById("message").value);
        wSocket.send(
          JSON.stringify({
            message: "add",
            data: newnew,
          })
        );
      }

      function checkRequest() {
        const { index, data } = blocks[blocks.length - 1];
        wSocket.send(
          JSON.stringify({
            message: "check",
            data: { index, data },
          })
        );
      }

      function checkResponse(requester) {
        wSocket.send(
          JSON.stringify({
            message: "check",
            data: { requester, checker: userId, result: true },
          })
        );
      }
    </script>
  </head>
  <body>
    <input type="button" onclick="doOpen();" value="Open" />
    <input type="button" onclick="doClose();" value="Close" />
    <input type="text" placeholder="Message" id="message" />
    <input type="button" onclick="add();" value="add" />
    <input type="button" onclick="checkRequest();" value="check" />
    <h3 id="result">로그</h3>
  </body>
</html>
