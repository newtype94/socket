<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebSocket test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script type="text/javascript">
      let wSocket;
      let logs;
      const userId = "kyh";
      const calculateHash = ({
        index,
        previousHash,
        createdAt,
        tx_userId,
        tx_voiceHash,
        tx_timeStamp,
      }) =>
        CryptoJS.SHA256(
          index +
            previousHash +
            createdAt +
            tx_userId +
            tx_voiceHash +
            tx_timeStamp
        ).toString();

      let blocks = [
        {
          index: 1,
          hash: "firstBlockHash",
          previousHash: "none",
          createdAt: 1562000010000,
          tx_userId: "kyh",
          tx_voiceHash: "firstVoiceHash",
          tx_timeStamp: 1562000000000,
        },
        {
          index: 2,
          hash:
            "d058abab5582e7ec62dd7e29768931d7970679460468b29a1d9380d4ea870950",
          previousHash: "firstBlockHash",
          createdAt: 1587000010000,
          tx_userId: "kyh",
          tx_voiceHash: "secondVoiceHash",
          tx_timeStamp: 1587000000000,
        },
        {
          index: 3,
          hash:
            "a9a811cfb7f0549ae95ff488a0ef49be7c15998d226824b6475a86f27db901fa",
          previousHash: "secondBlockHash",
          createdAt: 1588000010000,
          tx_userId: "kyh",
          tx_voiceHash: "thirdVoiceHash",
          tx_timeStamp: 1588000000000,
        },
      ];

      const onMessage = (e) => {
        const got = JSON.parse(e.data);
        console.log("[" + got.message + "]" + got.data);
        switch (got.message) {
          case "checkPlz":
            checkPlzHandler(got.data);
            break;
          case "addPlz":
            //RN에서는 sql로 insert
            blocks.push(got.data);
            break;
          case "checkResult":
            break;
          case "addFailed":
            break;
          default:
            break;
        }
      };

      const doOpen = () => {
        wSocket = new WebSocket(
          "wss://9qmjknn869.execute-api.ap-northeast-2.amazonaws.com/Prod"
        );
        wSocket.onopen = () => {
          logs.textContent += "opened";
        };
        wSocket.onclose = () => {
          logs.textContent += `\n` + "WebSocket closed!";
        };
        wSocket.onerror = (e) => {
          logs.textContent += "Error : " + e.data;
        };
        wSocket.onmessage = onMessage;
      };

      const addRequest = () => {
        const newBlock = {
          index: blocks[blocks.length - 1].index + 1,
          hash: "to be calculated",
          previousHash: blocks[blocks.length - 1].index + 1,
          createdAt: new Date().getTime(), //1588000000000,
          tx_userId: userId,
          tx_voiceHash: document.getElementById("MSG").value,
          tx_timeStamp: new Date().getTime(), //1588000000000,
        };
        newBlock.hash = calculateHash(newBlock);
        console.log(newBlock);
        wSocket.send(
          JSON.stringify({
            message: "add",
            data: newBlock,
          })
        );
      };

      const checkRequest = () => {
        const selected = blocks[blocks.length - 1];
        const { index, tx_voiceHash, tx_userId, tx_timeStamp } = selected;
        wSocket.send(
          JSON.stringify({
            message: "check",
            data: { index, tx_voiceHash, tx_userId, tx_voiceHash },
          })
        );
      };

      const checkPlzHandler = ({
        requester,
        index,
        tx_timeStamp,
        tx_userId,
        tx_voiceHash,
      }) => {
        const selected = blocks[index];
        const result =
          selected.tx_timeStamp === tx_timeStamp &&
          selected.tx_userId === tx_userId &&
          selected.tx_voiceHash === tx_voiceHash;
        wSocket.send(
          JSON.stringify({
            message: "check",
            data: { requester, result, checker: userId },
          })
        );
      };

      const myBlockCheck = async () => {
        const myLastBlock = blocks[blocks.length - 1];

        let query =
          "https://cophwimxel.execute-api.ap-northeast-2.amazonaws.com/prod/check?" +
          "index=" +
          myLastBlock.index +
          "&hash=" +
          myLastBlock.hash +
          "&previousHash=" +
          myLastBlock.previousHash +
          "&createdAt=" +
          myLastBlock.createdAt +
          "&tx_userId=" +
          myLastBlock.tx_userId +
          "&tx_voiceHash=" +
          myLastBlock.tx_voiceHash +
          "&tx_timeStamp=" +
          myLastBlock.tx_timeStamp;

        const got = await axios.get(query, { crossdomain: true });
        logs.textContent += JSON.stringify(got.data);
      };

      window.onload = () => {
        logs = document.getElementById("result");
        doOpen();
      };
    </script>
  </head>
  <body>
    <input type="button" onclick="doOpen();" value="Open" />
    <input type="button" onclick="wSocket.close()" value="Close" /><br />
    <input type="text" placeholder="voice hash for new block" id="MSG" />
    <input type="button" onclick="addRequest();" value="새 블록 생성" />
    <input type="button" onclick="checkRequest();" value="검증 요청 보내기" />
    <input type="button" onclick="myBlockCheck();" value="마지막 블록 체크" />
    <h3 id="result">로그</h3>
  </body>
</html>
